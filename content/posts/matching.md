---
title: "图匹配全解"
date: 2025-04-12T14:05:29+08:00
draft: true
math: true
tags: ["网络流", "一般图最大权匹配"]
categories: ["图论"]
---

给定无向图 $G = (V, E)$，匹配是一个满足其中边两两不共端点的边集 $M \subseteq E$；而完美匹配则是一个包含 $V$ 中所有点作为端点的匹配。图的最大匹配问题即给定一个权重函数 $w: E \rightarrow \mathbb{R}$，要求寻找一个最大化 $\sum\limits_{e \in M} w(e)$ 的匹配 $M$。图的最大匹配问题有如下几个被广泛研究的特例：

- $\forall e \in E: w(e) = 1$：最大基数匹配问题
- 要求在匹配基数最大的前提下最大化权值：最大权最大匹配问题
- 要求匹配 $M$ 为完美匹配时：完美匹配问题
- $G$ 为二分图：二分图匹配问题

图的**最大权**匹配问题和**最大权最大**匹配问题都可以在多项式时间内归约为对方。

- 用零权边将图补为完全图，即可以**最大权最大**匹配问题的算法解决**最大权**匹配问题。
- 令新权重函数 $w'(e) = w(e) + |V|W$（$W$ 为图中所有边权的绝对值的最大值），即可以**最大权**匹配问题解决**最大权最大**匹配问题。

因此，我们接下来只讨论最大权最大匹配问题，在匹配基数最大的前提下最大化匹配权值。

## 二分图最大匹配

当能够将点集 $V$ 分为不交的两份 $A, B$ 且所有边的两个端点均分属 $A, B$ 时，我们称 $G$ 为二分图。图为二分图的充要条件是图不含长度为奇数的环。在相当多的情况下，我们都在二分图上解决最大匹配问题。

### 网络流

基于原图 $G = (V, E)$ 构建一张新的图 $G'$：源点往 $A$ 中点连一条单位流量边，$B$ 中点往汇点连一条单位流量边，对于 $E$ 中每条边都在 $G'$ 中连一条相应的从 $A$ 往 $B$ 的单位流量边。这样的图 $G'$ 的最大流即为原图 $G$ 的最大匹配的基数，被流过的边的集合即为一个最大匹配。这是因为可行流和匹配间能够建立双射关系，最大可行流也是最大匹配。在二分图上运行 Dinic 算法可以确保 $O(|E|\sqrt{|V|})$ 的时间复杂度。

对于二分图上带权的最大匹配问题，可以使用费用流算法解决。取决于费用流算法的实现，时间复杂度为 $O(|V||E|)$ 或更低。

### KM 算法

Kuhn–Munkres 算法，又称匈牙利算法，是一个基于增广路求解二分图最大匹配问题的算法。

#### 交错路和增广路

在匹配状况为 $M$ 的前提下，$M$-交错路是指满足这样条件的一条路径：起点为未匹配节点，路径以未匹配边和已匹配边交替。一条长度为奇数的 $M$-交错路被称为 $M$-增广路，将其中上的未匹配边和已匹配边翻转，就可以使匹配基数增加 $1$。如果我们能在图中找到一条增广路，就可以将匹配基数增加 $1$；如果图中不存在增广路，根据 Berge 定理可知当前已得最大匹配；因此我们可以通过在图中寻找增广路来求最大匹配。

##### Berge 定理

> 图 $G$ 中不存在 $M$-增广路是 $M$ 为最大匹配的充要条件。

必要性是显然的，我们只需为该定理证明充分性：若不存在 $M$-增广路且 $M$ 不为最大匹配，则存在一个最大匹配 $M^\ast$ 且 $|M^\ast| > |M|$。考虑二者的对称差 $M \Delta M^\ast = (M \setminus M^\ast) \cup (M^\ast \setminus M)$ 构成的子图 $G' = (V, M \Delta M^\ast)$。显然图 $G'$ 中任何点的度数均小于等于 $2$，故 $G'$ 中只存在单纯的环和路径作为连通块，而不存在任何分叉图形（例如非退化的树、环嵌套）；进一步地，$G'$ 也不含奇环，因为奇环中必定要有两条相邻的边来自同一个匹配。故 $G'$ 只含偶环和路径。

由于 $G'$ 中任何两条相邻的边都不能来自同一个匹配，这些偶环和路径都是交错的。如果所有路径长度均为偶数，结合交错的性质可以推导出 $|M^\ast| = |M|$，故至少有一个长度为奇数的路径，该路径对 $M$ 来说是一条增广路。

#### 寻找增广路

根据 Berge 定理，不停寻找增广路，直到 $G$ 中不再存在增广路，即可得 $G$ 的最大匹配。这个过程和网络流一致，仿照 Dinic 算法的方法寻找最短路，即为 Hopcroft–Karp 算法。Hopcroft-Karp 算法是基于三条重要结论的：

1. 能够以 $O(|E|)$ 的复杂度找到一个顶点不交的最短增广路径集合；
2. 对这些路径增广后，图的最短增广路径的长度会增加；
3. 进行 $k$ 轮这样的增广后，当前匹配基数距最大匹配基数不多于 $\frac{|V|}{k+1}$。

这使得 Hopcroft-Karp 算法只需进行 $O(\sqrt{|V|})$ 轮复杂度为 $O(|E|)$ 的增广，确保 $O(|E|\sqrt{|V|})$ 的复杂度。对这些结论我们不加证明。

下面介绍 KM 算法寻找增广路的方法。

我们从任意一个未匹配节点 $s$ 出发，期望通过交错路到达一个未匹配节点 $t$。我们发现，在通过 DFS 搜索该路径的过程中，我们接下来须走交错路中的匹配边还是未匹配边，仅仅与当前所处节点有关，而与我们是如何到达该节点的无关；我们是如何到达该节点的，与我们接下来的行动无关（这一点对非二分图不成立）。因此，我们不必搜索已访问过的节点，于是我们可以得到一个类似 DFS 树的结构，称作**交错树**。如搜索到了未匹配节点，则找到了增广路；如搜索不到，我们也已确实穷尽了所有可行的本质不同的路径，可确信无从 $s$ 出发的增广路。

顺序对所有点应用上述算法（如其仍未匹配），即可得最大匹配。时间复杂度为 $O(|V||E|)$。

#### 处理带权的最大匹配

KM 算法相比 Hopcroft-Karp 算法和 Dinic 算法更慢，但可用于带权的二分图**完美**匹配。为了使任意二分图有完美匹配，需要补点补边。

考虑为顶点分配一组顶标 $\ell: V \rightarrow \mathbb{R}$。在接下来的过程我们会不断调整 $\ell$，但始终保证 $\forall (u, v) \in E: \ell(u) + \ell(v) \ge w(u, v)$。可采用 $\ell(x) = \max\limits_y \{w(x, y)\}$ 作为一组初始顶标。

我们称 $G$ 的 $\ell$-相等子图为仅保留 $G$ 中满足 $w(u, v) = \ell(u) + \ell(v)$ 的边得到的子图。当调整 $\ell$ 使得 $G$ 的 $\ell$-相等子图有完美匹配 $M$ 时，$M$ 也为 $G$ 的最大权最大匹配。这是因为 $\sum \ell$ 大于等于 $G$ 的任意完美匹配的权值，而 $M$ 的权值恰为 $\sum \ell$。于是我们的目标就是在保证 $\ell(u) + \ell(v) \ge w(u, v)$ 的前提下调整 $\ell$ 使得 $G$ 的 $\ell$-相等子图有完美匹配。

考虑在当前的 $\ell$-相等子图上从任意未匹配节点 $s$ 出发，若寻找到一增广路则可增广，否则将得一交错树。设交错树上和起点奇偶性相同的点集为 $S$，其余点的集合为 $T$，则 $S$ 中节点仅和 $T$ 中节点有边相连，否则交错树可增长。令 $f = \min\limits_{x \in S, y \notin T, (x, y) \in E} \ell(x) + \ell(y) - w(x, y)$，使 $S$ 中节点顶标减少 $f$，$T$ 中节点顶标增加 $f$，则：

- $\ell$-相等子图中连接 $S$ 和 $T$ 的边将保留，不破坏已形成的交错树；
- $\ell$-相等子图中连接 $T$ 和 $S$ 外的边将被移除，但这些边均不在匹配中，故匹配数不减小；
- $\ell$-相等子图中将增加一些连接 $S$ 和 $T$ 外节点的边，可以利用这些边扩展交错树。

执行上述步骤，交错树中节点将不断拓展，并最终产生一个从 $s$ 出发的增广路。$n$ 次这样的增广即可使 $G$ 的 $\ell$-相等子图具有完美匹配，即 $G$ 的最大权完美匹配。用合适的方法实现，可达成 $O(|V|^3)$ 的时间复杂度。

### 二分图有完美匹配的充要条件

## 一般图最大匹配
